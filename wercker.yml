box: golang

launch-build:
  steps:
    - script:
        name: Commit hash of change being built
        code: git rev-parse HEAD    

    - script:
        name: Commit detail
        code: git show
      
development-build:
  steps:
    - wercker/setup-go-workspace:
        package-dir: github.com/mevansam/cf-copy-plugin

    - script:
        name: Set VAR
        code: export TEST_VAR="Hello WORLD!"     

    - script:
        name: Get govendor
        code: |
          go get -u github.com/kardianos/govendor

    - script:
        name: Synchronize vendored dependencies
        code: |
          govendor sync

    - script:
        name: Build
        code: |
          go build ./...

    - script:
        name: Run unit tests
        code: |
          govendor test +local

    - script:
        name: Show VAR
        code: echo $TEST_VAR

release-build:
  steps:
    - wercker/setup-go-workspace:
        package-dir: github.com/mevansam/cf-copy-plugin

    - wercker/add-to-known_hosts:
        hostname: github.com

    - add-ssh-key:
        keyname: GIT_RELEASE_KEY
        host: github.com

    - script:
        name: Build All
        code: |
          git config --global user.email "$GIT_USER_EMAIL"
          git config --global user.name "$GIT_USER_NAME"
          git config --global push.default simple

          set +e
          git tag -l --points-at HEAD | grep "^[0-9]*\.[0-9]*\.[0-9]*$" 2>&1 > /dev/null
          if [[ $? -eq 0 ]]; then
            ./build-all.sh release
            touch $WERCKER_OUTPUT_DIR/release
          else
            echo "Changes made to branch 'master' does not have an associated tag. This is a NOP workflow."
          fi
          set -e

integration-test:
  steps:
    - script:
        name: Echo done
        code: |
          set -x
          git show-ref --tags
          git rev-parse HEAD
          git log --format=%B -n 1 $WERCKER_GIT_COMMIT
          git describe --abbrev=0 --tags

          if [[ -e $WERCKER_OUTPUT_DIR/release ]]; then
            echo "INTEGRATION TESTS SUCCESSFUL!!!"
          else
            echo "Skipping pipeline in NOP workflow."
          fi

deploy:
  steps:
    - script:
        name: Echo done
        code: |
          if [[ -e $WERCKER_OUTPUT_DIR/release ]]; then
            echo "DEPLOY DONE!!!"
          else
            echo "Skipping pipeline in NOP workflow."
          fi
