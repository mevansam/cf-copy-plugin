box: golang

build:
  steps:
    - wercker/setup-go-workspace:
      package-dir: github.com/mevansam/cf-copy-plugin

    - script:
      name: Set VAR
      code: export TEST_VAR="Hello WORLD!"     

    - script:
      name: Get govendor
      code: |
        go get -u github.com/kardianos/govendor

    - script:
      name: Synchronize vendored dependencies
      code: |
        govendor sync

    - script:
      name: Build
      code: |
        go build ./...

    - script:
      name: Run unit tests
      code: |
        govendor test +local

    - script:
      name: Show VAR
      code: echo $TEST_VAR

release-build:
  steps:
    - wercker/setup-go-workspace:
      package-dir: github.com/mevansam/cf-copy-plugin

    - script:
      name: Check if TAG is set
      code: |
        [ `git tag -l --points-at HEAD` | grep "^[0-9]*\.[0-9]*\.[0-9]*$" && exit 0
        exit 1

    - script:
      name: Get govendor
      code: |
        go get -u github.com/kardianos/govendor

    - script:
      name: Synchronize vendored dependencies
      code: |
        govendor sync

    - script:
      name: Run unit tests
      code: |
        govendor test +local

    - script:
      name: Build all
      code: |
        TAG=$(git tag -l --points-at HEAD)
        echo $TAG | grep "^[0-9]*\.[0-9]*\.[0-9]*$" 2>&1 > /dev/null
        if [[ $? -eq 1 ]]; then
          exit 1
        fi
        ./build-all.sh release $TAG

integration-test:
  steps:
    - script:
      name: Echo done
      code: |
        echo "INTEGRATION TESTS SUCCESSFUL!!!"

deploy:
  steps:
    - script:
      name: Echo done
      code: |
        echo "DEPLOY DONE!!!"